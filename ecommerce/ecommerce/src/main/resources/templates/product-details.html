<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title th:text="${product.name}">Szczeg√≥≈Çy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5 mb-5">
  <a href="/" class="btn btn-outline-secondary mb-4">&larr; Powr√≥t</a>

  <div class="card shadow-sm border-0 mb-5">
    <div class="row g-0">
      <div class="col-md-6 bg-white d-flex align-items-center justify-content-center p-4">
        <img th:src="${product.image_url != null} ? @{'/product-images/' + ${product.image_url}} : 'https://via.placeholder.com/400'"
             class="img-fluid" style="max-height: 500px;" alt="Zdjƒôcie produktu">
      </div>

      <div class="col-md-6">
        <div class="card-body p-5">
          <h2 th:text="${product.name}" class="fw-bold">Nazwa</h2>

          <div class="d-flex align-items-center mb-3">
            <h3 class="text-success m-0 me-3" th:text="${product.price} + ' PLN'">Cena</h3>
            <div class="text-warning fs-5">
              <span th:text="${product.averageRating != null ? #numbers.formatDecimal(product.averageRating, 1, 1) : '0.0'}">0.0</span>
              <span>‚≠ê</span>
            </div>
            <small class="text-muted ms-2">(<span th:text="${product.reviewCount}">0</span> opinii)</small>
          </div>

          <p class="lead" th:text="${product.description}">Opis...</p>

          <hr>

          <div class="d-grid gap-2">
            <form th:action="@{/cart/add}" method="post">
              <input type="hidden" name="productId" th:value="${product.id}">
              <input type="hidden" name="quantity" value="1">
              <button type="submit" class="btn btn-success w-100">
                Dodaj do koszyka üõí
              </button>
            </form>
          </div>

          <div class="mt-3 text-muted">
            Stan magazynowy: <span th:text="${product.quantity}"></span> szt.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h3 class="mb-4 border-bottom pb-2">Opinie Klient√≥w</h3>

      <div class="card bg-white mb-4" sec:authorize="isAuthenticated()">
        <div class="card-body">
          <h5 class="card-title">Dodaj swojƒÖ opiniƒô</h5>
          <form th:action="@{'/product/' + ${product.id} + '/reviews'}" method="post">
            <div class="row">
              <div class="col-md-2 mb-3">
                <label class="form-label">Ocena</label>
                <select name="rating" class="form-select">
                  <option value="5">5 - Super</option>
                  <option value="4">4 - Dobry</option>
                  <option value="3">3 - Mo≈ºe byƒá</option>
                  <option value="2">2 - S≈Çabo</option>
                  <option value="1">1 - Tragedia</option>
                </select>
              </div>
              <div class="col-md-10 mb-3">
                <label class="form-label">Tre≈õƒá</label>
                <textarea name="content" class="form-control" rows="2" placeholder="Napisz co my≈õlisz..." required></textarea>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Wy≈õlij opiniƒô</button>
          </form>
        </div>
      </div>

      <div class="alert alert-secondary" sec:authorize="!isAuthenticated()">
        <a href="/login" class="fw-bold">Zaloguj siƒô</a>, aby dodaƒá opiniƒô.
      </div>

      <div class="list-group">
        <div th:each="review : ${reviews}" class="list-group-item p-3">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1 fw-bold" th:text="${review.user.name}">U≈ºytkownik</h6>
            <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'dd-MM-yyyy HH:mm')}">Data</small>
          </div>
          <div class="text-warning mb-2">
            <span th:text="${review.rating}">5</span>/5 ‚≠ê
          </div>
          <p class="mb-1 text-break" th:text="${review.content}">Tre≈õƒá opinii...</p>
          
          <div sec:authorize="hasAuthority('ADMIN')" class="mt-2 text-end">
             <a th:href="@{'/admin/reviews/delete/' + ${review.id}}" 
                class="btn btn-sm btn-danger"
                onclick="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô opiniƒô?')">Usu≈Ñ (Admin)</a>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-5 text-muted bg-white border rounded">
          <p class="h5">Ten produkt nie ma jeszcze opinii.</p>
          <p>BƒÖd≈∫ pierwszy!</p>
        </div>
      </div>
    </div>
  </div>

</div>

</body>
</html>